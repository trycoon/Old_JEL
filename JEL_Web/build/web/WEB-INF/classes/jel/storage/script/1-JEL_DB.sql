
CREATE TABLE IF NOT EXISTS JEL_SETTINGS
(
    SettingsKey VARCHAR(50) NOT NULL PRIMARY KEY,
    SettingsValue VARCHAR(2048) NOT NULL
);

CREATE TABLE IF NOT EXISTS JELUSER
(
    ID INTEGER NOT NULL AUTO_INCREMENT(1,1) PRIMARY KEY,
    Username VARCHAR(20) NOT NULL UNIQUE,
    Firstname VARCHAR(30),
    Lastname VARCHAR(30),
    Description VARCHAR(2048),
    Password VARCHAR(128) NOT NULL,
    CreateTime TIMESTAMP NOT NULL,
    LastLoggedInTime TIMESTAMP,
    IsDisabled BOOLEAN NOT NULL DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS EVENT_TYPE
(
    ID SMALLINT NOT NULL AUTO_INCREMENT(1,1) PRIMARY KEY,
    Eventname VARCHAR(20) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS EVENT
(
    EventType SMALLINT NOT NULL,
    UserID INTEGER NOT NULL,
    EventTime TIMESTAMP NOT NULL,
    Message VARCHAR(2000),

    PRIMARY KEY (EventType, UserID, EventTime),
    CONSTRAINT EventType_FK FOREIGN KEY (EventType) REFERENCES EVENT_TYPE (ID) ON UPDATE NO ACTION ON DELETE CASCADE,
    CONSTRAINT EventUser_FK FOREIGN KEY (UserID) REFERENCES JELUSER (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS USER_SESSION
(
    UserID INTEGER NOT NULL,
    Token VARCHAR(50) NOT NULL,
    ActiveTime TIMESTAMP NOT NULL,

    PRIMARY KEY(UserID, Token),
    CONSTRAINT Usersession_FK FOREIGN KEY (UserID) REFERENCES JELUSER (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS SITE
(
    ID SMALLINT NOT NULL AUTO_INCREMENT(1,1) PRIMARY KEY,
    Sitename VARCHAR(50) NOT NULL UNIQUE,
    Description VARCHAR(512),
    CreateTime TIMESTAMP NOT NULL,
    SizeWidth SMALLINT NOT NULL DEFAULT 1024,
    SizeHeight SMALLINT NOT NULL DEFAULT 768,
    BgColor VARCHAR(20),
    BgImageUrl VARCHAR(200),
    BgImageRepeatX BOOLEAN NOT NULL DEFAULT FALSE,
    BgImageRepeatY BOOLEAN NOT NULL DEFAULT FALSE,
    AllowAnonymousUsers BOOLEAN NOT NULL DEFAULT FALSE,
    Longitude VARCHAR(20),
    Latitude VARCHAR(20)
);

CREATE TABLE IF NOT EXISTS SITE_USER
(
    UserID INTEGER NOT NULL,
    SiteID SMALLINT NOT NULL,
    PermissionID SMALLINT NOT NULL,
    
    PRIMARY KEY (UserID, SiteID),
    CONSTRAINT User_FK FOREIGN KEY (UserID) REFERENCES JELUSER (ID) ON UPDATE NO ACTION ON DELETE CASCADE,
    CONSTRAINT Usersite_FK FOREIGN KEY (SiteID) REFERENCES SITE (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS SITE_SETTINGS
(
    UserID INTEGER NOT NULL,
    SiteID SMALLINT NOT NULL,
    SettingsKey VARCHAR(50) NOT NULL,
    SettingsValue VARCHAR(2000) NOT NULL,

    PRIMARY KEY (UserID, SiteID, SettingsKey),
    CONSTRAINT SiteSettingsUser_FK FOREIGN KEY (UserID) REFERENCES JELUSER (ID) ON UPDATE NO ACTION ON DELETE CASCADE,
    CONSTRAINT SiteSettingsSite_FK FOREIGN KEY (SiteID) REFERENCES SITE (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DEVICE_TYPE
(
    ID SMALLINT NOT NULL AUTO_INCREMENT(1,1),
    Typename VARCHAR(50) NOT NULL UNIQUE,

    PRIMARY KEY(ID)
);

CREATE TABLE IF NOT EXISTS DEVICE
(
    ID SMALLINT NOT NULL AUTO_INCREMENT(1,1),
    SiteID SMALLINT NOT NULL,
    Devicename VARCHAR(20),
    Description VARCHAR(500),
    DeviceTypeID SMALLINT NOT NULL,

    PRIMARY KEY(ID),
    CONSTRAINT DeviceSite_FK FOREIGN KEY (SiteID) REFERENCES SITE (ID) ON UPDATE NO ACTION ON DELETE CASCADE,
    CONSTRAINT DeviceType_FK FOREIGN KEY (DeviceTypeID) REFERENCES DEVICE_TYPE (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS DeviceSiteIDIndex ON DEVICE(SiteID);
CREATE INDEX IF NOT EXISTS DeviceTypeIndex ON DEVICE(DeviceTypeID);

CREATE TABLE IF NOT EXISTS DEVICE_SETTINGS
(
    DeviceID SMALLINT NOT NULL,
    SettingsKey VARCHAR(50) NOT NULL,
    SettingsValue VARCHAR(2000) NOT NULL,

    PRIMARY KEY (DeviceID, SettingsKey),
    CONSTRAINT DeviceSettings_FK FOREIGN KEY (DeviceID) REFERENCES DEVICE (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DEVICE_SAMPLE
(
    DeviceID SMALLINT NOT NULL,
    DeviceTimestamp TIMESTAMP NOT NULL,
    DeviceValue DOUBLE NOT NULL,

    PRIMARY KEY (DeviceID, DeviceTimestamp),
    CONSTRAINT Devicesample_FK FOREIGN KEY (DeviceID) REFERENCES DEVICE (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS LINKAGE
(
    DeviceID1 SMALLINT NOT NULL,
    DeviceID2 SMALLINT NOT NULL,

    PRIMARY KEY (DeviceID1, DeviceID2),
    CONSTRAINT Linkage1_FK FOREIGN KEY (DeviceID1) REFERENCES DEVICE (ID) ON UPDATE NO ACTION ON DELETE CASCADE,
    CONSTRAINT Linkage2_FK FOREIGN KEY (DeviceID2) REFERENCES DEVICE (ID) ON UPDATE NO ACTION ON DELETE CASCADE
);

/*
 * Load basic information into tables
 */
INSERT INTO JELUSER (Username, Password, CreateTime, IsDisabled)
SELECT 'admin', 'jGl25bVBBBW96Qi9Te4V37Fnqchz/Eu4qB9vKrRIqRg=', CURRENT_TIMESTAMP, FALSE
WHERE NOT EXISTS (SELECT 1 FROM JELUSER WHERE Username='admin');

INSERT INTO JEL_SETTINGS (SettingsKey, SettingsValue)
SELECT 'DB_Version', '0.0.7'
WHERE NOT EXISTS (SELECT 1 FROM JEL_SETTINGS WHERE SettingsKey='DB_Version');

INSERT INTO EVENT_TYPE (Eventname)
SELECT 'UserLogin'
WHERE NOT EXISTS (SELECT 1 FROM EVENT_TYPE WHERE Eventname='UserLogin');

INSERT INTO EVENT_TYPE (Eventname)
SELECT 'UserLogout'
WHERE NOT EXISTS (SELECT 1 FROM EVENT_TYPE WHERE Eventname='UserLogout');

INSERT INTO DEVICE_TYPE (Typename)
SELECT 'Sensor'
WHERE NOT EXISTS (SELECT 1 FROM DEVICE_TYPE WHERE Typename='Sensor');

INSERT INTO DEVICE_TYPE (Typename)
SELECT 'Actuator'
WHERE NOT EXISTS (SELECT 1 FROM DEVICE_TYPE WHERE Typename='Actuator');
